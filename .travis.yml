---
arch: amd64
os: linux
dist: focal
language: cpp
compiler: gcc
env:
  - VCPKG_TRIPLET=x64-linux

git:
  strategy: clone
  depth: false

addons:
  sonarcloud:
    organization: "ots-1"
    token:
      secure: TD/0eEeWeQr932hYD60+l2bcDjg+8nZsoRNXn1WJp3MdUO2nms2azZkoTVzelldh6GbfSQdDBfXVwwA251zpCaUuHuKGEWmdVJhbHeXAta7TXkA92c/GQRDVCTRemplHR/dTdEJvpYkopjE1I9KjaIdh37xflmmasw2j1VrVH4w9qAG+SWvab085tpnrGEFwONuMfwJg0RHOIeKC9IACk0pnAJI3XPmzA07Zdtdp696PWr8cFC8WI89Opo33gPOq3jfRyKPWxkTpUe4o91Ear+dtusv9N8enXr/uH8uy8+xEXSb8qcs9hNvH/PRQlltYN+SL0kJP62fkK5RK9sQPXyjI5hDYVt1sQ4LjeIjJzYQ6Co+T7AHhbdHxsO/TxC+7qk/97Iw61XNUWtnKDkZRwOQNHOGCC+Vz+tyHCEO+ScccaF9bJUtEecSZ2QqlHWCqpJYDJLhgkkEpI8Xm6S4iIN+s/pqQCnD2bQ+yIyVzlzdcuW11zxDY5AaCc3htkDSYABrNOSkT8X/lUHYFjOSqLhNzWMENv01WdwagHagZ3yi2KaZgOoLxGIYKjgyIcK4X0mVVgCOHl8WoCwhwuQuu8C80INh5MzxhYaKkmjj5H6UuUUrsemYsTZzTdsLoK18u3tTjDRi8/RyGWt/qJjGx6+uiDCM/VhtLRLySLhPPYWU=
  apt:
    update: true
    packages:
      - ccache
      - build-essential
      - cmake
      - libluajit-5.1-dev
      - tar
      - curl
      - zip
      - unzip

install:
  - cd /home/travis/build/Beats-Dh
  - git clone https://github.com/microsoft/vcpkg
  - ./vcpkg/bootstrap-vcpkg.sh
  - ./vcpkg/vcpkg integrate install

script:
  - cd /home/travis/build/Beats-Dh/Gha
  - export CXXFLAGS="$CXXFLAGS -DBOOST_ASIO_DISABLE_NOEXCEPT=1 "
  - /home/travis/build/Beats-Dh/vcpkg/vcpkg --feature-flags=binarycaching,manifests,versions install
  - mkdir build
  - cd build
  - cmake -DCMAKE_TOOLCHAIN_FILE=/home/travis/build/Beats-Dh/vcpkg/scripts/buildsystems/vcpkg.cmake ..
  - cd ..
  - NUMBER_OF_PROCESSORS=$(nproc --all)
  - build-wrapper-linux-x86-64 --out-dir bw-output cmake --build build/
  - sonar-scanner -Dsonar.cfamily.cache.enabled=true -Dsonar.cfamily.cache.path=${TRAVIS_HOME}/.cfamily -Dsonar.cfamily.threads=${NUMBER_OF_PROCESSORS} || true

  # - sonar-scanner -Dsonar.cfamily.cache.enabled=true -Dsonar.cfamily.cache.path=${TRAVIS_HOME}/.cfamily -Dsonar.cfamily.threads=${NUMBER_OF_PROCESSORS} || true
  # - curl --upload-file /home/travis/build/Beats-Dh/Gha/sonar-cfamily-reproducer.zip https://transfer.sh/sonar-cfamily-reproducer.zip

cache:
  directories:
    - $HOME/.sonar/cache
    - $HOME/.cache
    - $HOME/.ccache
    - $HOME/.cfamily
